<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    * { padding: 0; margin: 0; outline: none; }
    .area{ height: 80px; width: 400px; background: #ccc; border: 1px solid #999; }
  </style>
</head>
<body>

<div class="area"></div>

<script src="socket.io.js"></script>
<script>
  // 字符串转为ArrayBuffer对象，参数为字符串
  function stringToArrayBuffer(str){
    if(/[\u0080-\uffff]/.test(str)){
      throw new Error("this needs encoding, like UTF-8");
    }
    var arr = new Uint8Array(str.length);
    for(var i=str.length; i--; )
      arr[i] = str.charCodeAt(i);
    return arr.buffer;
  }

  function arrayBufferToString(buffer){
    var arr = new Uint8Array(buffer);
    if (!("TextDecoder" in window))
      alert("Sorry, this browser does not support TextDecoder...");

    var enc = new TextDecoder();
    var str = enc.decode(arr);
    if(/[\u0080-\uffff]/.test(str)){
      throw new Error("this string seems to contain (still encoded) multibytes");
    }
    return str;
  }

  function getPackage(package, str, opcode=0){
    const message = stringToArrayBuffer(str);
    const messageArr = new Uint8Array(message);
//    for(let i = 0; i < message.length; i++){
//      package[i+4] = message[i];
//      console.log(package[i+4]);
//    }
    const dv = new Uint8Array(package);
    console.log("length==>", str.length);
    dv[0] = opcode;
    dv[1] = str.length & 0xff;
    dv[2] = (str.length & 0xff00) >> 8;
    dv[3] = (str.length & 0xff0000) >> 16;
    dv[4] = (str.length & 0xff000000) >> 24;
    dv.set(messageArr, 5);
    console.log(dv[0],dv[1],dv[2],dv[3],dv[4],dv[5],dv[6]);
    return dv.buffer;
  }

  function getPayLoad(payload, options){
    return JSON.stringify(Object.assign(payload, options));
  }

  const socket = new WebSocket('ws://10.0.15.59:9000');
  const payload = {
    "protocol":"0",
    "type":"0",
    "mode":"0",
    "encrypt":"0",
    "speed":"0",
    "transfered":"0",
    "total": "262149",
    "status": "0",
    "uuid": '' + new Date().getTime(),
    "ip":"10.0.14.57",
    "port":"36201",
    "log":"none",
    "reserve":"none",
  }
  socket.binaryType = "arraybuffer";
  let package = new ArrayBuffer(256*1024 + 5);
  const options = {
    "transfered":"0",
    "total": "262149",
    "status": "0",
  }

  socket.onopen = function (){
    console.log('connect success');
    let message = getPayLoad(payload, options);
    package = getPackage(package, message, 0);
    console.log("content==>", package.byteLength);
    socket.send(package);
    //socket.send(package);
  }

  socket.onmessage = function (msg){
    console.log("msg", msg.data);
//    var dv = new DataView(msg.data);
//    var optcode = dv.getUint8(0);
//    var length = dv.getUint32(1);
//    var messageBuffer = dv.byteOffset(5).buffer;

    console.log('server says:', optcode);
  }

  socket.onerror = function(e){
    console.log("error===>", e);
  }

  socket.onclose = function(){
    console.log("server closed===>");
  }

//  socket.on('open', function(socket){
//    console.log('a user connected');
//
//    socket.on('message', function(){
//      console.log('user disconnected');
//    });
//
//    socket.on('disconnect', function(){
//      console.log('user disconnected');
//    });
//
//    socket.send('asdfadfasdfasdfasdfasdfasdfasdfasdf');
//  });

  const ipt = document.querySelector('.area');
  ipt.ondragover = function () { return false; };

  // Add drop handler
  ipt.ondrop = function(e) {
    e.stopPropagation();
    e.preventDefault();
    e = e || window.event;
    const files = e.dataTransfer.files;

    console.log(files);
  };
</script>
</body>
</html>
